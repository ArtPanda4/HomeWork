---
- name: build app
  hosts: build
  become: yes
  
  tasks:
  - name: Install java
    apt:
      name: default-jdk
      state: present

  - name: Install maven
    apt:
      name: maven
      state: present

  - name: Install git
    apt:
      name: git
      state: present

  - name: git clone boxfuse
    command: git clone https://github.com/boxfuse/boxfuse-sample-java-war-hello.git
    args:
      chdir: /tmp

  - name: build a war
    command: mvn package
    args:
      chdir: /tmp/boxfuse-sample-java-war-hello

  - name: Synchronization of src on the control machine to dest on the remote hosts
    ansible.posix.synchronize:
      src: ./
      dest: /tmp


  - name: Build an image and push it to dockerhub
    community.docker.docker_image:
      build:
        path: /tmp
      repository: artpanda/hw-09
      push: yes
      source: build

- name: start on prod
  hosts: prod
  become: yes

  tasks:
  - name: Start a container
    docker_container:
      name: hw-09
      state: started
      image: "artpanda/hw-09:latest"
      pull: true
      ports:
        - "8080:8080"